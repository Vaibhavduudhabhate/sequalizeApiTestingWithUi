<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        th, td {
            border: 1px solid;
            padding: 10px;
        }
       
    </style>
</head>
<body>
    <div class="container d-flex flex-column justify-content-center align-items-center">
        <h1 class="m-5">User Data</h1>
        <div id="user-container"></div>
        <!-- <button id="add-user-button" class="btn btn-success m-5">Add User</button> -->
        <button type="button" id="add-user-button" class="btn btn-primary m-5" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Add User
          </button>
    </div>
      
      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h2>Add User</h2>
                <form id="add-user-form">
                    <label for="first-name">First Name:</label><br>
                    <input type="text" id="first-name" name="first-name" required><br>
                    <label for="last-name">Last Name:</label><br>
                    <input type="text" id="last-name" name="last-name" required><br><br>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </form>
            </div>
            
          </div>
        </div>
      </div>

   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userContainer = document.getElementById('user-container');
            const addUserButton = document.getElementById('add-user-button');
            const addUserForm = document.getElementById('add-user-form');
            let apiUrl = 'http://localhost:3001'

            addUserForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                
                try {
                    const response = await fetch(`${apiUrl}/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ first_name: firstName, last_name: lastName })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    
                    const newUser = await response.json();
                    console.log('New user added:', newUser);
                    fetchUserDataAndGenerateTable();
                } catch (error) {
                    console.error('Error adding user:', error);
                }
            });
            
            async function fetchUserDataAndGenerateTable() {
            }

            async function fetchUserDataAndGenerateTable() {
                try {
                    const response = await fetch(`${apiUrl}/users`);

                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }

                    const data = await response.json();
                    console.log('Data received:', data);

                    if (data.data && Array.isArray(data.data)) {
                        let tableHTML = `
                            <table border="1">
                                <tr>
                                    <th>ID</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Actions</th>
                                </tr>
                        `;

                        data.data.forEach(user => {
                            tableHTML += `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.first_name}</td>
                                    <td>${user.last_name}</td>
                                    <td>${new Date(user.createdAt).toLocaleString()}</td>
                                    <td>${new Date(user.updatedAt).toLocaleString()}</td>
                                    <td>
                                        <button class="update btn btn-success" data-id="${user.id}">Update</button>
                                        <button class="delete btn btn-danger" data-id="${user.id}">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                            </table>
                        `;

                        userContainer.innerHTML = tableHTML;

                        // Add event listeners after generating the table
                        document.querySelectorAll('.update').forEach(button => {
                            button.addEventListener('click', async () => {
                                const userId = button.getAttribute('data-id');
                                console.log('Update clicked for user ID:', userId);
                                await updateUser(userId);
                            });
                        });

                        document.querySelectorAll('.delete').forEach(button => {
                            button.addEventListener('click', async () => {
                                const userId = button.getAttribute('data-id');
                                console.log('Delete clicked for user ID:', userId);
                                await deleteUser(userId);
                            });
                        });
                    } else {
                        userContainer.innerHTML = '<p>No user data found.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    userContainer.innerHTML = `<p>Failed to load user data: ${error.message}</p>`;
                }
            }

            async function updateUser(userId) {
                try {
                    const response = await fetch(`${apiUrl}/user/${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }

                    const data = await response.json();
                    console.log('Update successful:', data);
                    fetchUserDataAndGenerateTable(); 
                } catch (error) {
                    console.error('Error updating user:', error);
                }
            }

            async function deleteUser(userId) {
                try {
                    const response = await fetch(`${apiUrl}/user/${userId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }

                    const data = await response.json();
                    console.log('Delete successful:', data);
                    fetchUserDataAndGenerateTable(); 
                } catch (error) {
                    console.error('Error deleting user:', error);
                }
            }

            fetchUserDataAndGenerateTable(); 
        });
    </script>
</body>
</html>
